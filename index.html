<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransBridge - 大语言模型翻译网关</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .bg-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #7dd3fc 100%);
        }
        .demo-container {
            min-height: 400px;
        }
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        .translation-panel {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .textarea-container {
            height: 180px;
            position: relative;
        }
        .textarea-container textarea {
            height: 100%;
            resize: none;
            overflow-y: auto;
            padding-bottom: 40px;
        }
        .character-count {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: #6b7280;
        }
        .swap-btn {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
<!-- 导航栏 -->
<nav class="bg-white shadow-md">
    <div class="container mx-auto px-6 py-3 flex justify-between items-center">
        <div class="flex items-center">
            <span class="text-2xl font-bold text-indigo-600">TransBridge</span>
            <span class="ml-2 text-sm bg-indigo-100 text-indigo-800 py-1 px-2 rounded">翻译网关</span>
        </div>
        <div class="flex items-center space-x-4">
            <a href="https://github.com/fruitbars/transbridge" class="text-gray-700 hover:text-indigo-600" target="_blank">
                <i class="fab fa-github text-xl"></i>
            </a>
            <a href="https://github.com/fruitbars/transbridge#readme" class="hidden md:block text-gray-700 hover:text-indigo-600" target="_blank">文档</a>
            <a href="#demo" class="hidden md:block text-gray-700 hover:text-indigo-600">在线演示</a>
            <a href="#features" class="hidden md:block text-gray-700 hover:text-indigo-600">特性</a>
        </div>
    </div>
</nav>

<!-- Hero 部分 (简短版) -->
<header class="bg-gradient text-white py-10">
    <div class="container mx-auto px-6 text-center">
        <h1 class="text-3xl md:text-4xl font-bold mb-3">TransBridge 大语言模型翻译网关</h1>
        <p class="text-lg md:text-xl mb-5">基于大语言模型的高性能翻译服务，使用DeepL API接口来调用大模型翻译</p>
    </div>
</header>

<!-- 谷歌风格翻译界面 -->
<section id="demo" class="py-10 bg-white">
    <div class="container mx-auto px-6">
        <h2 class="text-2xl md:text-3xl font-bold text-center mb-8">在线体验</h2>

        <!-- 语言选择区域 -->
        <div class="max-w-5xl mx-auto bg-white rounded-t-lg border border-gray-200 border-b-0 p-4">
            <div class="flex flex-wrap justify-center items-center">
                <div class="mr-2 mb-2">
                    <select id="source-lang" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                        <option value="AUTO">自动检测</option>
                        <option value="EN">英语</option>
                        <option value="ZH">中文</option>
                        <option value="JA">日语</option>
                        <option value="KO">韩语</option>
                        <option value="FR">法语</option>
                        <option value="DE">德语</option>
                        <option value="ES">西班牙语</option>
                        <option value="IT">意大利语</option>
                        <option value="RU">俄语</option>
                    </select>
                </div>

                <!-- 交换语言按钮 -->
                <button id="swap-lang-btn" class="mx-2 mb-2 bg-white border border-gray-200 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-50 focus:outline-none">
                    <i class="fas fa-exchange-alt text-indigo-600"></i>
                </button>

                <div class="ml-2 mb-2">
                    <select id="target-lang" class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                        <option value="ZH">中文</option>
                        <option value="EN">英语</option>
                        <option value="JA">日语</option>
                        <option value="KO">韩语</option>
                        <option value="FR">法语</option>
                        <option value="DE">德语</option>
                        <option value="ES">西班牙语</option>
                        <option value="IT">意大利语</option>
                        <option value="RU">俄语</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 翻译面板 -->
        <div class="max-w-5xl mx-auto translation-panel bg-white rounded-b-lg border border-gray-200 demo-container relative">
            <div class="flex flex-col md:flex-row">
                <!-- 左侧：原文输入 -->
                <div class="w-full md:w-1/2 p-4 border-b md:border-b-0 md:border-r border-gray-200 textarea-container">
                    <textarea id="source-text" class="w-full h-full p-3 border-none focus:outline-none focus:ring-0" placeholder="请输入要翻译的文本..."></textarea>
                    <div id="source-count" class="character-count">0/5000</div>

                    <!-- 原文功能按钮 -->
                    <div class="absolute bottom-2 left-4 flex space-x-2">
                        <button id="clear-source-btn" class="text-gray-500 hover:text-gray-700 p-1" title="清空文本">
                            <i class="fas fa-times-circle"></i>
                        </button>
                        <button id="copy-source-btn" class="text-gray-500 hover:text-gray-700 p-1" title="复制文本">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- 右侧：译文显示 -->
                <div class="w-full md:w-1/2 p-4 textarea-container bg-gray-50">
                    <div id="translated-text" class="w-full h-full p-3 overflow-y-auto"></div>

                    <!-- 译文功能按钮 -->
                    <div class="absolute bottom-2 left-4 flex space-x-2">
                        <button id="copy-translated-btn" class="text-gray-500 hover:text-gray-700 p-1" title="复制译文">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 翻译按钮区域（调整为更小尺寸） -->
            <div class="border-t border-gray-200 p-3 flex justify-between items-center">
                <div class="flex items-center">
                    <div id="status-message" class="text-gray-500 text-sm mr-3"></div>
                    <div id="translation-time" class="text-xs text-gray-400 hidden">耗时: <span id="time-value">0</span>ms</div>
                </div>
                <button id="translate-btn" class="bg-indigo-600 text-white font-medium py-1.5 px-4 rounded hover:bg-indigo-700 transition duration-200 flex items-center text-sm">
                    <i class="fas fa-language mr-1.5"></i>翻译
                </button>
            </div>

            <!-- 错误信息 -->
            <div id="error-container" class="p-4 hidden">
                <div id="error-message" class="p-3 bg-red-50 text-red-600 border border-red-200 rounded fade-in text-sm"></div>
            </div>

            <!-- 调试信息区域 - 可根据需要显示/隐藏 -->
            <div id="debug-container" class="p-2 border-t border-gray-200 hidden">
                <div class="text-xs text-gray-500 whitespace-pre-wrap" id="debug-output"></div>
            </div>

            <!-- 加载指示器 (更小、更不突兀) -->
            <div id="loading" class="absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center hidden">
                <div class="bg-white rounded-lg shadow-md p-3 flex items-center">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-600 mr-2"></div>
                    <p class="text-sm text-gray-600">正在翻译...</p>
                </div>
            </div>
        </div>

        <div class="text-center mt-6">
            <p class="text-gray-600">API 服务: <a href="https://freeapi.fanyimao.cn/" class="text-indigo-600 hover:underline">https://freeapi.fanyimao.cn/</a></p>
            <p class="text-xs text-gray-500 mt-1">使用 Authorization: Bearer tr-98584e33-f387-42cc-a467-f02513bd400d</p>
        </div>
    </div>
</section>

<!-- 主要特性部分 -->
<section id="features" class="py-16 bg-gray-50">
    <div class="container mx-auto px-6">
        <h2 class="text-3xl font-bold text-center mb-12">主要特性</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                <div class="text-indigo-600 text-4xl mb-4">
                    <i class="fas fa-layer-group"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">多模型支持</h3>
                <p class="text-gray-600">支持多种 AI 翻译模型，如 OpenAI、ChatGLM、DeepSeek 等，基于权重的模型选择策略。</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                <div class="text-indigo-600 text-4xl mb-4">
                    <i class="fas fa-database"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">多级缓存</h3>
                <p class="text-gray-600">支持内存缓存和 Redis 缓存，灵活配置缓存策略，提高翻译效率。</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                <div class="text-indigo-600 text-4xl mb-4">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">API 兼容</h3>
                <p class="text-gray-600">兼容 DeepL API 接口格式，支持 OpenAI 兼容接口，便于应用迁移。</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                <div class="text-indigo-600 text-4xl mb-4">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">安全认证</h3>
                <p class="text-gray-600">支持 API 密钥认证机制，保护您的 API 不被未授权访问。</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                <div class="text-indigo-600 text-4xl mb-4">
                    <i class="fas fa-file-alt"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">日志记录</h3>
                <p class="text-gray-600">异步日志系统，支持自动轮转和长期存储，便于追踪和分析。</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition duration-200">
                <div class="text-indigo-600 text-4xl mb-4">
                    <i class="fas fa-rocket"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">高性能设计</h3>
                <p class="text-gray-600">异步处理、多级缓存和优化的网络请求，提升整体性能。</p>
            </div>
        </div>
    </div>
</section>

<!-- 页脚 -->
<footer class="bg-gray-800 text-white py-8">
    <div class="container mx-auto px-6">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="mb-4 md:mb-0">
                <span class="text-xl font-bold">TransBridge</span>
                <span class="ml-2 text-gray-400">多模型翻译网关</span>
            </div>
            <div class="flex space-x-4">
                <a href="https://github.com/fruitbars/transbridge" class="text-gray-400 hover:text-white" target="_blank">
                    <i class="fab fa-github text-xl"></i>
                </a>
                <a href="https://github.com/fruitbars/transbridge#readme" class="text-gray-400 hover:text-white" target="_blank">文档</a>
                <a href="https://freeapi.fanyimao.cn/" class="text-gray-400 hover:text-white" target="_blank">API</a>
            </div>
        </div>
        <div class="mt-4 text-center text-gray-400 text-sm">
            <p>&copy; 2025 TransBridge. MIT 许可证开源。</p>
        </div>
    </div>
</footer>

<!-- 脚本 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 调试日志函数
        function debugLog(message) {
            const debugContainer = document.getElementById('debug-container');
            const debugOutput = document.getElementById('debug-output');

            if (debugOutput) {
                const timestamp = new Date().toISOString().substr(11, 8);
                debugOutput.textContent += `[${timestamp}] ${message}\n`;

                // 自动滚动到底部
                debugOutput.scrollTop = debugOutput.scrollHeight;
            }

            // 打印到控制台以便调试
            console.log(message);
        }

        // 检测是否为移动设备
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            debugLog("检测到移动设备");
        } else {
            debugLog("检测到桌面设备");
        }

        // 获取DOM元素
        const translateBtn = document.getElementById('translate-btn');
        const sourceText = document.getElementById('source-text');
        const sourceLang = document.getElementById('source-lang');
        const targetLang = document.getElementById('target-lang');
        const translatedText = document.getElementById('translated-text');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const loading = document.getElementById('loading');
        const sourceCount = document.getElementById('source-count');
        const swapLangBtn = document.getElementById('swap-lang-btn');
        const clearSourceBtn = document.getElementById('clear-source-btn');
        const copySourceBtn = document.getElementById('copy-source-btn');
        const copyTranslatedBtn = document.getElementById('copy-translated-btn');
        const statusMessage = document.getElementById('status-message');

        // API URL
        const API_URL = 'https://freeapi.fanyimao.cn/translate';

        // 更新字符计数
        function updateCharCount() {
            const count = sourceText.value.length;
            sourceCount.textContent = `${count}/5000`;

            // 如果超过限制，改变颜色
            if (count > 5000) {
                sourceCount.classList.add('text-red-600');
            } else {
                sourceCount.classList.remove('text-red-600');
            }
        }

        // 输入时更新字符计数
        sourceText.addEventListener('input', updateCharCount);

        // 自动翻译（当用户停止输入一段时间后）
        let typingTimer;
        const doneTypingInterval = 1000; // 1秒

        sourceText.addEventListener('keyup', function() {
            clearTimeout(typingTimer);
            if (sourceText.value) {
                typingTimer = setTimeout(autoTranslate, doneTypingInterval);
            }
        });

        sourceText.addEventListener('keydown', function() {
            clearTimeout(typingTimer);
        });

        // 自动翻译函数
        function autoTranslate() {
            // 如果文本不为空，且有不同于上一次的值
            if (sourceText.value.trim() && sourceText.dataset.lastTranslated !== sourceText.value) {
                // 设置状态消息而不是显示加载动画
                statusMessage.textContent = "正在自动翻译...";
                translate(true); // 传入true表示这是自动翻译
            }
        }

        // 使用XMLHttpRequest的传统翻译函数
        function legacyTranslate(text, sourceLangVal, targetLangVal) {
            return new Promise((resolve, reject) => {
                debugLog("使用XMLHttpRequest发送请求");

                const xhr = new XMLHttpRequest();
                xhr.open('POST', API_URL, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Authorization', 'Bearer tr-98584e33-f387-42cc-a467-f02513bd400d');
                xhr.timeout = 20000; // 20秒超时

                xhr.onload = function() {
                    debugLog(`收到响应: 状态 ${xhr.status}`);
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            debugLog("响应解析成功");
                            resolve(data);
                        } catch (e) {
                            debugLog(`解析响应失败: ${e.message}`);
                            reject(new Error('解析响应失败'));
                        }
                    } else {
                        debugLog(`HTTP错误: ${xhr.status}`);
                        reject(new Error(`HTTP错误: ${xhr.status}`));
                    }
                };

                xhr.onerror = function() {
                    debugLog("网络请求失败");
                    reject(new Error('网络请求失败'));
                };

                xhr.ontimeout = function() {
                    debugLog("请求超时");
                    reject(new Error('请求超时'));
                };

                const requestData = JSON.stringify({
                    text: text,
                    source_lang: sourceLangVal === "AUTO" ? "" : sourceLangVal,
                    target_lang: targetLangVal
                });

                debugLog(`请求数据: ${requestData}`);
                xhr.send(requestData);
            });
        }

        // 使用fetch API的现代翻译函数
        async function modernTranslate(text, sourceLangVal, targetLangVal) {
            debugLog("使用Fetch API发送请求");

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); // 20秒超时

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer tr-98584e33-f387-42cc-a467-f02513bd400d'
                    },
                    body: JSON.stringify({
                        text: text,
                        source_lang: sourceLangVal === "AUTO" ? "" : sourceLangVal,
                        target_lang: targetLangVal
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                debugLog(`收到响应: 状态 ${response.status}`);

                if (!response.ok) {
                    throw new Error(`HTTP错误 ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                debugLog("响应解析成功");
                return data;
            } catch (error) {
                if (error.name === 'AbortError') {
                    debugLog("请求超时");
                    throw new Error('请求超时');
                }
                throw error;
            }
        }

        // 翻译函数
        async function translate(isAuto = false) {
            const text = sourceText.value.trim();
            if (!text) {
                showError('请输入要翻译的文本');
                return;
            }

            // 存储当前文本，用于自动翻译比较
            sourceText.dataset.lastTranslated = text;

            // 如果不是自动翻译，显示加载动画
            if (!isAuto) {
                loading.classList.remove('hidden');
                statusMessage.textContent = "";
            }

            errorContainer.classList.add('hidden');
            document.getElementById('translation-time').classList.add('hidden');

            // 记录开始时间
            const startTime = performance.now();

            try {
                debugLog("开始翻译请求");

                let data;
                // 根据设备类型选择不同的请求方法
                if (isMobile) {
                    data = await legacyTranslate(text, sourceLang.value, targetLang.value);
                } else {
                    data = await modernTranslate(text, sourceLang.value, targetLang.value);
                }

                // 计算耗时并显示
                const endTime = performance.now();
                const timeTaken = Math.round(endTime - startTime);
                document.getElementById('time-value').textContent = timeTaken;
                document.getElementById('translation-time').classList.remove('hidden');

                debugLog(`响应数据: ${JSON.stringify(data).substring(0, 100)}...`);

                if (data.code === 200 || (data.translations && data.translations.length > 0)) {
                    // 处理新的API响应格式
                    let translatedContent = data.translations ? data.translations[0].text : data.data;
                    debugLog(`翻译内容获取成功: ${translatedContent.substring(0, 50)}...`);

                    translatedText.textContent = translatedContent;
                    // 翻译完成后更新状态
                    statusMessage.textContent = "翻译完成";
                    setTimeout(() => {
                        statusMessage.textContent = "";
                    }, 2000);
                } else {
                    debugLog(`翻译失败: ${data.message || data.data || '未知错误'}`);
                    showError(`翻译失败: ${data.message || data.data || '未知错误'}`);
                }
            } catch (error) {
                debugLog(`错误: ${error.message}`);

                // 区分不同类型的错误
                if (error.name === 'AbortError' || error.message.includes('timeout')) {
                    showError("请求超时，请检查网络连接或稍后再试");
                } else if (error.message.includes('NetworkError') || error.message.includes('network')) {
                    showError("网络错误，请检查您的网络连接");
                } else if (error.message.includes('解析')) {
                    showError("响应解析失败，服务器返回了无效数据");
                } else {
                    showError(`请求错误: ${error.message}`);
                }
            } finally {
                loading.classList.add('hidden');
            }
        }

        // 点击翻译按钮
        translateBtn.addEventListener('click', function() {
            translate();
        });

        // 显示错误
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
            statusMessage.textContent = "";
            debugLog(`显示错误: ${message}`);
        }

        // 交换语言
        swapLangBtn.addEventListener('click', function() {
            debugLog("交换语言");
            // 不交换自动检测
            if (sourceLang.value === "AUTO") {
                showError("自动检测语言不能交换");
                return;
            }

            const sourceVal = sourceLang.value;
            sourceLang.value = targetLang.value;
            targetLang.value = sourceVal;

            // 如果已经有译文，也交换文本
            if (translatedText.textContent) {
                const tempText = sourceText.value;
                sourceText.value = translatedText.textContent;
                translatedText.textContent = tempText;
                updateCharCount();
            }
        });

        // 清空原文
        clearSourceBtn.addEventListener('click', function() {
            debugLog("清空原文");
            sourceText.value = '';
            translatedText.textContent = '';
            updateCharCount();
        });

        // 复制原文
        copySourceBtn.addEventListener('click', function() {
            debugLog("复制原文");
            copyText(sourceText.value, copySourceBtn);
        });

        // 复制译文
        copyTranslatedBtn.addEventListener('click', function() {
            debugLog("复制译文");
            copyText(translatedText.textContent, copyTranslatedBtn);
        });

        // 通用复制函数
        function copyText(text, button) {
            if (!text) return;

            try {
                // 尝试使用现代Clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    debugLog("使用Clipboard API复制");
                    navigator.clipboard.writeText(text).then(function() {
                        showCopySuccess(button);
                    }).catch(function(err) {
                        debugLog("Clipboard API失败: " + err);
                        fallbackCopy(text, button);
                    });
                } else {
                    debugLog("使用fallback复制方法");
                    fallbackCopy(text, button);
                }
            } catch (err) {
                debugLog("复制过程出错: " + err);
                showError('复制失败，请手动复制');
            }
        }

        // 后备复制方法
        function fallbackCopy(text, button) {
            try {
                // 创建临时文本区域
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                // 执行复制命令
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);

                if (successful) {
                    showCopySuccess(button);
                } else {
                    showError('复制失败，请手动复制');
                }
            } catch (err) {
                debugLog("后备复制失败: " + err);
                showError('复制失败，请手动复制');
            }
        }

        // 显示复制成功
        function showCopySuccess(button) {
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                button.innerHTML = originalHTML;
            }, 2000);
        }

        // 支持快捷键
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + Enter 触发翻译
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                translate();
            }
        });

        // 初始化设置
        updateCharCount();

        // 可选：显示调试信息区域（在生产环境中删除）
        // document.getElementById('debug-container').classList.remove('hidden');

        // 检查是否移动设备加载完成
        debugLog("初始化完成，可以开始使用");

        // 添加CORS请求前缀
        document.addEventListener('fetch', function(event) {
            debugLog("拦截fetch请求");
        }, true);
    });
</script>
</body>
</html>